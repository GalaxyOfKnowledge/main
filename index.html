<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinoy Quiz Trivia Space Invader</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        #gameCanvas {
            display: block;
            background-color: black;
            margin: 0 auto;
        }
        
        #menuScreen, #gameOverScreen, #highscoreScreen, #settingsScreen, #triviaScreen, #bossBattleScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
        }
        
        .title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 40px;
            color: #fff;
            text-align: center;
        }
        
        .menu-button {
            width: 200px;
            height: 50px;
            margin: 10px;
            font-size: 20px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #playButton { background-color: #4CAF50; color: white; }
        #highscoreButton { background-color: #FFC107; color: black; }
        #settingsButton { background-color: #2196F3; color: white; }
        
        .question {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            max-width: 80%;
        }
        
        .option {
            width: 80%;
            max-width: 500px;
            padding: 10px;
            margin: 5px;
            background-color: #333;
            border: 2px solid #555;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }
        
        .option:hover {
            background-color: #444;
        }
        
        .option.correct {
            background-color: #4CAF50;
            border-color: #2E7D32;
        }
        
        .option.incorrect {
            background-color: #F44336;
            border-color: #C62828;
        }
        
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
        }
        
        #powerupHud {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 14px;
            text-align: right;
        }
        
        .powerup-indicator {
            margin: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        #bossHealthBar {
            width: 300px;
            height: 20px;
            background-color: #F44336;
            margin: 20px auto;
            position: relative;
        }
        
        #bossHealth {
            height: 100%;
            background-color: #4CAF50;
            width: 100%;
        }
        
        #bossTitle {
            color: #F44336;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        #nameInput {
            padding: 10px;
            font-size: 18px;
            width: 200px;
            margin: 10px;
        }
        
        .settings-row {
            margin: 15px;
            display: flex;
            align-items: center;
        }
        
        .settings-label {
            width: 200px;
            font-size: 18px;
        }
        
        .settings-value {
            width: 100px;
            text-align: center;
            font-size: 18px;
        }
        
        .settings-button {
            width: 40px;
            height: 40px;
            font-size: 20px;
            margin: 0 10px;
            cursor: pointer;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }
        
        #mobileControls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: none;
            justify-content: center;
        }
        
        .mobile-btn {
            width: 80px;
            height: 80px;
            margin: 0 20px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            user-select: none;
        }
        
        @media (max-width: 768px) {
            #mobileControls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <!-- Menu Screen -->
    <div id="menuScreen">
        <div class="title">Pinoy Quiz Trivia<br>Space Invader</div>
        <button id="playButton" class="menu-button">Play</button>
        <button id="highscoreButton" class="menu-button">Highscore</button>
        <button id="settingsButton" class="menu-button">Settings</button>
    </div>
    
    <!-- Game Over Screen -->
    <div id="gameOverScreen" style="display: none;">
        <div class="title">Game Over</div>
        <div id="finalScore" style="font-size: 24px; margin-bottom: 20px;"></div>
        <div id="nameInputContainer" style="display: none;">
            <div style="margin-bottom: 10px;">Enter your name:</div>
            <input type="text" id="nameInput" maxlength="10">
            <button id="submitScore" class="menu-button" style="background-color: #4CAF50;">Submit</button>
        </div>
        <button id="continueButton" class="menu-button" style="background-color: #2196F3;">Continue</button>
    </div>
    
    <!-- Highscore Screen -->
    <div id="highscoreScreen" style="display: none;">
        <div class="title">High Scores</div>
        <div id="highscoreList" style="margin-bottom: 30px;"></div>
        <button id="backButton" class="menu-button" style="background-color: #2196F3;">Back</button>
    </div>
    
    <!-- Settings Screen -->
    <div id="settingsScreen" style="display: none;">
        <div class="title">Settings</div>
        
        <div class="settings-row">
            <div class="settings-label">Music Volume:</div>
            <button id="musicDown" class="settings-button">-</button>
            <div id="musicVolume" class="settings-value">50%</div>
            <button id="musicUp" class="settings-button">+</button>
        </div>
        
        <div class="settings-row">
            <div class="settings-label">Sound Effects:</div>
            <button id="toggleSound" class="settings-button" style="width: 100px;">ON</button>
        </div>
        
        <div class="settings-row">
            <div class="settings-label">Difficulty:</div>
            <button id="changeDifficulty" class="settings-button" style="width: 100px;">NORMAL</button>
        </div>
        
        <button id="settingsBackButton" class="menu-button" style="background-color: #F44336; margin-top: 30px;">Back to Menu</button>
    </div>
    
    <!-- Trivia Screen -->
    <div id="triviaScreen" style="display: none;">
        <div id="triviaCategory" style="color: #FFC107; font-size: 20px; margin-bottom: 10px;"></div>
        <div id="triviaQuestion" class="question"></div>
        <div id="triviaOptions"></div>
        <div id="triviaFeedback" style="margin-top: 20px; font-size: 18px; color: #FFC107;"></div>
    </div>
    
    <!-- Boss Battle Screen -->
    <div id="bossBattleScreen" style="display: none;">
        <div id="bossTitle">BOSS BATTLE!</div>
        <div id="bossHealthBar"><div id="bossHealth"></div></div>
        <div id="bossQuestion" class="question"></div>
        <div id="bossOptions"></div>
        <div id="bossFeedback" style="margin-top: 20px; font-size: 18px; color: #FFC107;"></div>
    </div>
    
    <!-- HUD -->
    <div id="hud">
        <div>Lives: <span id="livesDisplay">3</span></div>
        <div>Score: <span id="scoreDisplay">0</span></div>
        <div>Level: <span id="levelDisplay">1</span></div>
    </div>
    
    <div id="powerupHud">
        <div class="powerup-indicator" id="barongIndicator" style="background-color: #2196F3;">Barong Shield: OFF</div>
        <div class="powerup-indicator" id="jeepneyIndicator" style="background-color: #F44336;">Jeepney Boost: OFF</div>
        <div class="powerup-indicator" id="tiniklingIndicator" style="background-color: #4CAF50;">Tinikling Mode: OFF</div>
    </div>
    
    <!-- Mobile Controls -->
    <div id="mobileControls">
        <div class="mobile-btn" id="leftBtn">‚Üê</div>
        <div class="mobile-btn" id="shootBtn">üî´</div>
        <div class="mobile-btn" id="rightBtn">‚Üí</div>
    </div>
    
    <script>
        // Game constants
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 600;
        
        // Game states
        const STATE_MENU = 0;
        const STATE_PLAYING = 1;
        const STATE_TRIVIA = 2;
        const STATE_GAME_OVER = 3;
        const STATE_HIGHSCORE = 4;
        const STATE_SETTINGS = 5;
        const STATE_BOSS_BATTLE = 6;
        
        // Initialize canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;
        
        // Game variables
        let gameState = STATE_MENU;
        let player = {
            x: CANVAS_WIDTH / 2 - 25,
            y: CANVAS_HEIGHT - 60,
            width: 50,
            height: 30,
            speed: 5,
            lives: 3,
            score: 0,
            level: 1,
            shipSkin: 'default',
            powerups: {
                barongShield: false,
                jeepneyBoost: false,
                tiniklingMode: false
            }
        };
        
        let bullets = [];
        let enemies = [];
        let powerups = [];
        let bulletCooldown = 0;
        let enemySpawnRate = 60;
        let enemySpawnTimer = 0;
        let levelTimer = 0;
        let levelDuration = 1800; // 30 seconds at 60fps
        let enemiesDefeated = 0;
        let enemiesToDefeat = 10;
        
        // Boss battle variables
        let bossHealth = 0;
        let bossQuestionsAnswered = 0;
        let bossQuestionsNeeded = 3;
        
        // Trivia variables
        let currentQuestion = null;
        let selectedOption = null;
        let triviaCorrect = false;
        
        // High scores
        let highScores = [];
        const MAX_HIGH_SCORES = 10;
        
        // Settings
        let settings = {
            musicVolume: 0.5,
            soundEffects: true,
            difficulty: 'normal' // easy, normal, hard
        };
        
        // Sound effects
        const sounds = {
            shoot: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-laser-weapon-shot-1680.mp3'),
            explosion: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-explosion-impact-1684.mp3'),
            powerup: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'),
            correct: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3'),
            wrong: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3')
        };
        
        // Set volume for all sounds
        Object.values(sounds).forEach(sound => {
            sound.volume = settings.soundEffects ? 0.5 : 0;
        });
        
        // Background music
        const backgroundMusic = new Audio('https://assets.mixkit.co/music/preview/mixkit-game-show-suspense-waiting-668.mp3');
        backgroundMusic.volume = settings.musicVolume;
        backgroundMusic.loop = true;
        
        // Trivia questions
        const triviaQuestions = [
            {
                question: "What is the national bird of the Philippines?",
                options: ["Maya", "Philippine Eagle", "Cockatoo", "Kingfisher"],
                answer: 1,
                category: "National Symbols",
                funFact: "The Philippine Eagle is one of the largest and most powerful eagles in the world!"
            },
            {
                question: "Which Philippine hero is known as the 'Sublime Paralytic'?",
                options: ["Jose Rizal", "Andres Bonifacio", "Apolinario Mabini", "Emilio Aguinaldo"],
                answer: 2,
                category: "History",
                funFact: "Mabini served as the first Prime Minister of the Philippines despite being paralyzed by polio."
            },
            {
                question: "What is the traditional Filipino leaf-wrapped rice cake?",
                options: ["Bibingka", "Puto", "Suman", "Kutsinta"],
                answer: 2,
                category: "Food",
                funFact: "Suman is usually made from glutinous rice cooked in coconut milk and wrapped in banana or palm leaves."
            },
            {
                question: "Which province is known as the 'Rice Granary of the Philippines'?",
                options: ["Bulacan", "Nueva Ecija", "Pampanga", "Tarlac"],
                answer: 1,
                category: "Geography",
                funFact: "Nueva Ecija produces the most rice in the country, contributing significantly to national food security."
            },
            {
                question: "What festival is celebrated in Cebu every third Sunday of January?",
                options: ["Sinulog", "Ati-Atihan", "Dinagyang", "Pahiyas"],
                answer: 0,
                category: "Culture",
                funFact: "Sinulog honors the Santo Ni√±o (Child Jesus) and features vibrant street dancing with participants in colorful costumes."
            },
            {
                question: "Which Filipino invention is used worldwide for medical testing?",
                options: ["Medical incubator", "Karaoke", "Arduino", "Salvage therapy"],
                answer: 0,
                category: "Science",
                funFact: "Fe del Mundo invented the bamboo incubator to help rural communities without electricity care for premature babies."
            },
            {
                question: "What is the capital of the Philippines?",
                options: ["Cebu", "Davao", "Manila", "Quezon City"],
                answer: 2,
                category: "Geography",
                funFact: "Manila is one of the most densely populated cities in the world with over 70,000 people per square mile!"
            },
            {
                question: "Which Philippine volcano erupted in 1991, the second largest eruption of the 20th century?",
                options: ["Mayon", "Taal", "Pinatubo", "Kanlaon"],
                answer: 2,
                category: "Geography",
                funFact: "The Pinatubo eruption cooled global temperatures by about 0.5¬∞C for the next two years."
            },
            {
                question: "What is the traditional Filipino martial art?",
                options: ["Karate", "Taekwondo", "Arnis", "Kung Fu"],
                answer: 2,
                category: "Culture",
                funFact: "Arnis was declared the national martial art and sport of the Philippines in 2009."
            },
            {
                question: "Which Filipino boxer became an eight-division world champion?",
                options: ["Manny Pacquiao", "Nonito Donaire", "Flash Elorde", "Pancho Villa"],
                answer: 0,
                category: "Sports",
                funFact: "Manny Pacquiao is the only boxer to win world titles in eight different weight divisions."
            }
        ];
        
        // Load high scores from localStorage
        function loadHighScores() {
            const savedScores = localStorage.getItem('pinoySpaceInvaderHighScores');
            if (savedScores) {
                highScores = JSON.parse(savedScores);
            } else {
                highScores = [
                    { name: "Jose", score: 10000 },
                    { name: "Maria", score: 8000 },
                    { name: "Juan", score: 6000 },
                    { name: "Ana", score: 4000 },
                    { name: "Pedro", score: 2000 }
                ];
            }
        }
        
        // Save high scores to localStorage
        function saveHighScores() {
            localStorage.setItem('pinoySpaceInvaderHighScores', JSON.stringify(highScores));
        }
        
        // Add a new high score
        function addHighScore(name, score) {
            highScores.push({ name, score });
            highScores.sort((a, b) => b.score - a.score);
            highScores = highScores.slice(0, MAX_HIGH_SCORES);
            saveHighScores();
        }
        
        // Load settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('pinoySpaceInvaderSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                updateSettingsUI();
            }
        }
        
        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('pinoySpaceInvaderSettings', JSON.stringify(settings));
            updateSettingsUI();
        }
        
        // Update settings UI elements
        function updateSettingsUI() {
            document.getElementById('musicVolume').textContent = `${Math.round(settings.musicVolume * 100)}%`;
            document.getElementById('toggleSound').textContent = settings.soundEffects ? 'ON' : 'OFF';
            document.getElementById('changeDifficulty').textContent = settings.difficulty.toUpperCase();
            
            // Update sound volumes
            backgroundMusic.volume = settings.musicVolume;
            Object.values(sounds).forEach(sound => {
                sound.volume = settings.soundEffects ? 0.5 : 0;
            });
            
            // Apply difficulty settings
            switch (settings.difficulty) {
                case 'easy':
                    player.speed = 6;
                    enemySpeed = 0.8;
                    break;
                case 'normal':
                    player.speed = 5;
                    enemySpeed = 1.0;
                    break;
                case 'hard':
                    player.speed = 4;
                    enemySpeed = 1.2;
                    break;
            }
        }
        
        // Initialize game
        function initGame() {
            loadHighScores();
            loadSettings();
            backgroundMusic.play().catch(e => console.log("Autoplay prevented:", e));
            
            // Set up event listeners
            document.getElementById('playButton').addEventListener('click', startGame);
            document.getElementById('highscoreButton').addEventListener('click', showHighScores);
            document.getElementById('settingsButton').addEventListener('click', showSettings);
            document.getElementById('continueButton').addEventListener('click', () => {
                gameState = STATE_MENU;
                document.getElementById('gameOverScreen').style.display = 'none';
                document.getElementById('menuScreen').style.display = 'flex';
            });
            document.getElementById('submitScore').addEventListener('click', submitHighScore);
            document.getElementById('backButton').addEventListener('click', () => {
                gameState = STATE_MENU;
                document.getElementById('highscoreScreen').style.display = 'none';
                document.getElementById('menuScreen').style.display = 'flex';
            });
            document.getElementById('settingsBackButton').addEventListener('click', () => {
                gameState = STATE_MENU;
                document.getElementById('settingsScreen').style.display = 'none';
                document.getElementById('menuScreen').style.display = 'flex';
                saveSettings();
            });
            
            // Settings controls
            document.getElementById('musicDown').addEventListener('click', () => {
                settings.musicVolume = Math.max(0, settings.musicVolume - 0.1);
                saveSettings();
            });
            document.getElementById('musicUp').addEventListener('click', () => {
                settings.musicVolume = Math.min(1, settings.musicVolume + 0.1);
                saveSettings();
            });
            document.getElementById('toggleSound').addEventListener('click', () => {
                settings.soundEffects = !settings.soundEffects;
                saveSettings();
            });
            document.getElementById('changeDifficulty').addEventListener('click', () => {
                const difficulties = ['easy', 'normal', 'hard'];
                const currentIndex = difficulties.indexOf(settings.difficulty);
                settings.difficulty = difficulties[(currentIndex + 1) % difficulties.length];
                saveSettings();
            });
            
            // Mobile controls
            document.getElementById('leftBtn').addEventListener('touchstart', () => {
                keys.ArrowLeft = true;
            });
            document.getElementById('leftBtn').addEventListener('touchend', () => {
                keys.ArrowLeft = false;
            });
            document.getElementById('rightBtn').addEventListener('touchstart', () => {
                keys.ArrowRight = true;
            });
            document.getElementById('rightBtn').addEventListener('touchend', () => {
                keys.ArrowRight = false;
            });
            document.getElementById('shootBtn').addEventListener('touchstart', () => {
                keys[' '] = true;
            });
            document.getElementById('shootBtn').addEventListener('touchend', () => {
                keys[' '] = false;
            });
            
            // Keyboard controls
            window.addEventListener('keydown', (e) => {
                if (e.key in keys) {
                    keys[e.key] = true;
                }
                
                // In game over screen, allow typing name
                if (gameState === STATE_GAME_OVER && document.getElementById('nameInputContainer').style.display !== 'none') {
                    if (e.key === 'Enter') {
                        submitHighScore();
                    }
                }
            });
            
            window.addEventListener('keyup', (e) => {
                if (e.key in keys) {
                    keys[e.key] = false;
                }
            });
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        }
        
        // Track pressed keys
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ' ': false
        };
        
        // Start a new game
        function startGame() {
            gameState = STATE_PLAYING;
            document.getElementById('menuScreen').style.display = 'none';
            
            // Reset player
            player = {
                x: CANVAS_WIDTH / 2 - 25,
                y: CANVAS_HEIGHT - 60,
                width: 50,
                height: 30,
                speed: 5,
                lives: 3,
                score: 0,
                level: 1,
                shipSkin: 'default',
                powerups: {
                    barongShield: false,
                    jeepneyBoost: false,
                    tiniklingMode: false
                }
            };
            
            // Reset game variables
            bullets = [];
            enemies = [];
            powerups = [];
            bulletCooldown = 0;
            enemySpawnRate = 60;
            enemySpawnTimer = 0;
            levelTimer = 0;
            enemiesDefeated = 0;
            enemiesToDefeat = 10;
            
            // Update HUD
            updateHUD();
            
            // Start background music
            backgroundMusic.currentTime = 0;
            backgroundMusic.play().catch(e => console.log("Autoplay prevented:", e));
        }
        
        // Show high scores
        function showHighScores() {
            gameState = STATE_HIGHSCORE;
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('highscoreScreen').style.display = 'flex';
            
            // Populate high score list
            const highscoreList = document.getElementById('highscoreList');
            highscoreList.innerHTML = '';
            
            highScores.forEach((score, index) => {
                const scoreElement = document.createElement('div');
                scoreElement.style.fontSize = '20px';
                scoreElement.style.margin = '5px';
                scoreElement.textContent = `${index + 1}. ${score.name} - ${score.score}`;
                highscoreList.appendChild(scoreElement);
            });
        }
        
        // Show settings
        function showSettings() {
            gameState = STATE_SETTINGS;
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('settingsScreen').style.display = 'flex';
        }
        
        // Game over
        function gameOver() {
            gameState = STATE_GAME_OVER;
            document.getElementById('gameOverScreen').style.display = 'flex';
            document.getElementById('finalScore').textContent = `Final Score: ${player.score}`;
            
            // Check if score qualifies for high score
            const qualifiesForHighScore = highScores.length < MAX_HIGH_SCORES || 
                                        player.score > highScores[highScores.length - 1].score;
            
            if (qualifiesForHighScore) {
                document.getElementById('nameInputContainer').style.display = 'block';
                document.getElementById('continueButton').style.display = 'none';
                document.getElementById('nameInput').focus();
            } else {
                document.getElementById('nameInputContainer').style.display = 'none';
                document.getElementById('continueButton').style.display = 'block';
            }
        }
        
        // Submit high score
        function submitHighScore() {
            const nameInput = document.getElementById('nameInput');
            if (nameInput.value.trim() !== '') {
                addHighScore(nameInput.value.trim(), player.score);
                nameInput.value = '';
                document.getElementById('nameInputContainer').style.display = 'none';
                document.getElementById('continueButton').style.display = 'block';
            }
        }
        
        // Show trivia question
        function showTriviaQuestion() {
            gameState = STATE_TRIVIA;
            document.getElementById('triviaScreen').style.display = 'flex';
            
            // Select a random question
            currentQuestion = triviaQuestions[Math.floor(Math.random() * triviaQuestions.length)];
            selectedOption = null;
            triviaCorrect = false;
            
            // Display question
            document.getElementById('triviaCategory').textContent = currentQuestion.category;
            document.getElementById('triviaQuestion').textContent = currentQuestion.question;
            
            // Display options
            const optionsContainer = document.getElementById('triviaOptions');
            optionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectTriviaOption(index));
                optionsContainer.appendChild(optionElement);
            });
            
            // Clear feedback
            document.getElementById('triviaFeedback').textContent = '';
        }
        
        // Select trivia option
        function selectTriviaOption(index) {
            if (selectedOption !== null) return; // Prevent multiple selections
            
            selectedOption = index;
            const options = document.querySelectorAll('#triviaOptions .option');
            
            if (index === currentQuestion.answer) {
                // Correct answer
                triviaCorrect = true;
                options[index].classList.add('correct');
                document.getElementById('triviaFeedback').textContent = 'Correct! ' + currentQuestion.funFact;
                
                // Play sound
                sounds.correct.play();
                
                // Apply bonus based on category
                switch (currentQuestion.category) {
                    case 'National Symbols':
                        player.lives++;
                        break;
                    case 'History':
                        player.score += 500;
                        break;
                    case 'Food':
                        // Spawn a power-up
                        spawnPowerUp();
                        break;
                    case 'Geography':
                        player.powerups.jeepneyBoost = true;
                        powerupTimers.jeepneyBoost = powerupDuration;
                        break;
                    case 'Culture':
                        // Unlock a random ship skin
                        const skins = ['default', 'bangka', 'jeepney', 'kite_fighter'];
                        player.shipSkin = skins[Math.floor(Math.random() * skins.length)];
                        break;
                    case 'Science':
                        player.score += 1000;
                        break;
                    case 'Sports':
                        player.powerups.tiniklingMode = true;
                        powerupTimers.tiniklingMode = powerupDuration;
                        break;
                }
                
                updateHUD();
            } else {
                // Wrong answer
                triviaCorrect = false;
                options[index].classList.add('incorrect');
                options[currentQuestion.answer].classList.add('correct');
                document.getElementById('triviaFeedback').textContent = 'Wrong! The correct answer is: ' + currentQuestion.options[currentQuestion.answer];
                
                // Play sound
                sounds.wrong.play();
                
                // Make game harder
                enemySpeed += 0.2;
                bulletCooldown += 10;
            }
            
            // Return to game after delay
            setTimeout(() => {
                document.getElementById('triviaScreen').style.display = 'none';
                gameState = STATE_PLAYING;
                
                // If correct, maybe spawn a power-up
                if (triviaCorrect && Math.random() < 0.3) {
                    spawnPowerUp();
                }
                
                // Advance level
                player.level++;
                levelTimer = 0;
                enemiesDefeated = 0;
                enemiesToDefeat = 10 + player.level * 2;
                
                updateHUD();
            }, 3000);
        }
        
        // Show boss battle
        function startBossBattle() {
            gameState = STATE_BOSS_BATTLE;
            document.getElementById('bossBattleScreen').style.display = 'flex';
            
            // Set boss stats
            bossHealth = 5 + player.level;
            bossQuestionsAnswered = 0;
            bossQuestionsNeeded = 3;
            
            // Update boss health display
            updateBossHealth();
            
            // Get first question
            getNextBossQuestion();
        }
        
        // Get next boss question
        function getNextBossQuestion() {
            currentQuestion = triviaQuestions[Math.floor(Math.random() * triviaQuestions.length)];
            selectedOption = null;
            
            // Display question
            document.getElementById('bossQuestion').textContent = currentQuestion.question;
            
            // Display options
            const optionsContainer = document.getElementById('bossOptions');
            optionsContainer.innerHTML = '';
            
            currentQuestion.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectBossOption(index));
                optionsContainer.appendChild(optionElement);
            });
            
            // Clear feedback
            document.getElementById('bossFeedback').textContent = '';
        }
        
        // Select boss option
        function selectBossOption(index) {
            if (selectedOption !== null) return; // Prevent multiple selections
            
            selectedOption = index;
            const options = document.querySelectorAll('#bossOptions .option');
            
            if (index === currentQuestion.answer) {
                // Correct answer
                options[index].classList.add('correct');
                document.getElementById('bossFeedback').textContent = 'Correct! ' + currentQuestion.funFact;
                sounds.correct.play();
                
                bossQuestionsAnswered++;
                updateBossHealth();
                
                if (bossQuestionsAnswered >= bossQuestionsNeeded) {
                    // Boss defeated
                    player.score += 2000;
                    setTimeout(() => {
                        document.getElementById('bossBattleScreen').style.display = 'none';
                        gameState = STATE_PLAYING;
                        
                        // Advance level
                        player.level++;
                        levelTimer = 0;
                        enemiesDefeated = 0;
                        enemiesToDefeat = 10 + player.level * 2;
                        
                        updateHUD();
                    }, 2000);
                } else {
                    // Next question
                    setTimeout(getNextBossQuestion, 2000);
                }
            } else {
                // Wrong answer
                options[index].classList.add('incorrect');
                options[currentQuestion.answer].classList.add('correct');
                document.getElementById('bossFeedback').textContent = 'Wrong! The correct answer is: ' + currentQuestion.options[currentQuestion.answer];
                sounds.wrong.play();
                
                // Boss attacks
                player.lives--;
                updateHUD();
                
                if (player.lives <= 0) {
                    gameOver();
                    return;
                }
                
                // Next question
                setTimeout(getNextBossQuestion, 2000);
            }
        }
        
        // Update boss health display
        function updateBossHealth() {
            const healthPercent = (bossQuestionsNeeded - bossQuestionsAnswered) / bossQuestionsNeeded * 100;
            document.getElementById('bossHealth').style.width = `${healthPercent}%`;
        }
        
        // Update HUD
        function updateHUD() {
            document.getElementById('livesDisplay').textContent = player.lives;
            document.getElementById('scoreDisplay').textContent = player.score;
            document.getElementById('levelDisplay').textContent = player.level;
            
            // Update powerup indicators
            document.getElementById('barongIndicator').textContent = 
                `Barong Shield: ${player.powerups.barongShield ? 'ACTIVE' : 'OFF'}`;
            document.getElementById('jeepneyIndicator').textContent = 
                `Jeepney Boost: ${player.powerups.jeepneyBoost ? 'ACTIVE' : 'OFF'}`;
            document.getElementById('tiniklingIndicator').textContent = 
                `Tinikling Mode: ${player.powerups.tiniklingMode ? 'ACTIVE' : 'OFF'}`;
        }
        
        // Enemy class
        class Enemy {
            constructor() {
                this.type = ['kapre', 'aswang', 'sarimanok'][Math.floor(Math.random() * 3)];
                
                if (this.type === 'kapre') {
                    this.width = 60;
                    this.height = 50;
                    this.health = 3;
                    this.speed = enemySpeed * 0.7;
                } else if (this.type === 'aswang') {
                    this.width = 30;
                    this.height = 20;
                    this.health = 1;
                    this.speed = enemySpeed * 1.5;
                } else { // sarimanok
                    this.width = 45;
                    this.height = 45;
                    this.health = 2;
                    this.speed = enemySpeed;
                }
                
                this.x = Math.random() * (CANVAS_WIDTH - this.width);
                this.y = -this.height;
            }
            
            update() {
                this.y += this.speed;
            }
            
            draw() {
                if (this.type === 'kapre') {
                    // Draw kapre (big, dark enemy)
                    ctx.fillStyle = '#654321';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    
                    // Eyes
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(this.x + 15, this.y + 15, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(this.x + this.width - 15, this.y + 15, 5, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.type === 'aswang') {
                    // Draw aswang (small, fast enemy)
                    ctx.fillStyle = '#800080';
                    ctx.beginPath();
                    ctx.moveTo(this.x + this.width/2, this.y);
                    ctx.lineTo(this.x, this.y + this.height);
                    ctx.lineTo(this.x + this.width, this.y + this.height);
                    ctx.closePath();
                    ctx.fill();
                } else { // sarimanok
                    // Draw sarimanok (colorful bird-like enemy)
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    
                    // Colorful details
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(this.x + 10, this.y + 10, 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'green';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width - 10, this.y + 10, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            isOffScreen() {
                return this.y > CANVAS_HEIGHT;
            }
            
            hit() {
                this.health--;
                return this.health <= 0;
            }
        }
        
        // Bullet class
        class Bullet {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 5;
                this.speed = 7;
                this.damage = player.powerups.tiniklingMode ? 2 : 1;
            }
            
            update() {
                this.y -= this.speed;
            }
            
            draw() {
                ctx.fillStyle = 'yellow';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            isOffScreen() {
                return this.y < 0;
            }
        }
        
        // Power-up class
        class PowerUp {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 30;
                this.height = 30;
                this.speed = 2;
                this.type = ['barongShield', 'jeepneyBoost', 'tiniklingMode'][Math.floor(Math.random() * 3)];
            }
            
            update() {
                this.y += this.speed;
            }
            
            draw() {
                if (this.type === 'barongShield') {
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.fillStyle = 'white';
                    ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, this.height - 10);
                } else if (this.type === 'jeepneyBoost') {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, this.height - 10);
                } else { // tiniklingMode
                    ctx.fillStyle = 'green';
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.fillStyle = 'white';
                    ctx.fillRect(this.x + 5, this.y + 5, this.width - 10, this.height - 10);
                }
            }
            
            isOffScreen() {
                return this.y > CANVAS_HEIGHT;
            }
        }
        
        // Spawn a power-up
        function spawnPowerUp() {
            powerups.push(new PowerUp(
                Math.random() * (CANVAS_WIDTH - 30),
                -30
            ));
        }
        
        // Power-up timers
        const powerupDuration = 300; // 5 seconds at 60fps
        const powerupTimers = {
            barongShield: 0,
            jeepneyBoost: 0,
            tiniklingMode: 0
        };
        
        // Update power-up timers
        function updatePowerupTimers() {
            for (const type in powerupTimers) {
                if (powerupTimers[type] > 0) {
                    powerupTimers[type]--;
                    if (powerupTimers[type] === 0) {
                        player.powerups[type] = false;
                        updateHUD();
                    }
                }
            }
        }
        
        // Draw player ship
        function drawPlayer() {
            if (player.powerups.barongShield) {
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.strokeRect(player.x - 5, player.y - 5, player.width + 10, player.height + 10);
            }
            
            ctx.fillStyle = 'green';
            
            if (player.shipSkin === 'default') {
                // Default ship
                ctx.fillRect(player.x, player.y, player.width, player.height);
                ctx.beginPath();
                ctx.moveTo(player.x + player.width/2, player.y - 10);
                ctx.lineTo(player.x, player.y + 10);
                ctx.lineTo(player.x + player.width, player.y + 10);
                ctx.closePath();
                ctx.fill();
            } else if (player.shipSkin === 'bangka') {
                // Bangka (outrigger boat)
                ctx.fillStyle = '#8B4513'; // brown
                ctx.fillRect(player.x, player.y, player.width, player.height/2);
                ctx.fillRect(player.x - 15, player.y + player.height/4, 15, 5);
                ctx.fillRect(player.x + player.width, player.y + player.height/4, 15, 5);
            } else if (player.shipSkin === 'jeepney') {
                // Jeepney
                ctx.fillStyle = '#FFD700'; // gold
                ctx.fillRect(player.x, player.y, player.width, player.height);
                ctx.fillStyle = 'red';
                ctx.fillRect(player.x + 5, player.y + 5, player.width - 10, player.height - 10);
                // Windows
                ctx.fillStyle = '#87CEEB'; // sky blue
                ctx.fillRect(player.x + 10, player.y + 10, 10, 10);
                ctx.fillRect(player.x + player.width - 20, player.y + 10, 10, 10);
            } else if (player.shipSkin === 'kite_fighter') {
                // Kite fighter
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.moveTo(player.x + player.width/2, player.y);
                ctx.lineTo(player.x, player.y + player.height);
                ctx.lineTo(player.x + player.width, player.y + player.height);
                ctx.closePath();
                ctx.fill();
            }
        }
        
        // Main game loop
        function gameLoop() {
            // Clear canvas
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            if (gameState === STATE_PLAYING) {
                // Move player
                if (keys.ArrowLeft) {
                    player.x -= player.speed * (player.powerups.jeepneyBoost ? 1.5 : 1);
                    if (player.x < 0) player.x = 0;
                }
                if (keys.ArrowRight) {
                    player.x += player.speed * (player.powerups.jeepneyBoost ? 1.5 : 1);
                    if (player.x > CANVAS_WIDTH - player.width) player.x = CANVAS_WIDTH - player.width;
                }
                
                // Shoot
                if (keys[' '] && bulletCooldown <= 0) {
                    bullets.push(new Bullet(player.x + player.width/2, player.y));
                    sounds.shoot.play();
                    bulletCooldown = 15;
                }
                
                if (bulletCooldown > 0) {
                    bulletCooldown--;
                }
                
                // Spawn enemies
                enemySpawnTimer++;
                if (enemySpawnTimer >= enemySpawnRate) {
                    enemySpawnTimer = 0;
                    if (enemies.length < 5 + player.level) {
                        enemies.push(new Enemy());
                    }
                    // Decrease spawn rate over time
                    enemySpawnRate = Math.max(20, enemySpawnRate - 0.1);
                }
                
                // Update bullets
                for (let i = bullets.length - 1; i >= 0; i--) {
                    bullets[i].update();
                    if (bullets[i].isOffScreen()) {
                        bullets.splice(i, 1);
                    }
                }
                
                // Update enemies
                for (let i = enemies.length - 1; i >= 0; i--) {
                    enemies[i].update();
                    if (enemies[i].isOffScreen()) {
                        enemies.splice(i, 1);
                        player.lives--;
                        updateHUD();
                        if (player.lives <= 0) {
                            gameOver();
                        }
                    }
                }
                
                // Check bullet-enemy collisions
                for (let i = bullets.length - 1; i >= 0; i--) {
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const bullet = bullets[i];
                        const enemy = enemies[j];
                        
                        if (bullet.x > enemy.x && bullet.x < enemy.x + enemy.width &&
                            bullet.y > enemy.y && bullet.y < enemy.y + enemy.height) {
                            
                            if (enemy.hit()) {
                                enemies.splice(j, 1);
                                enemiesDefeated++;
                                player.score += enemy.type === 'kapre' ? 100 : 
                                              enemy.type === 'sarimanok' ? 50 : 30;
                                
                                // Chance to drop power-up
                                if (Math.random() < 0.1) {
                                    powerups.push(new PowerUp(
                                        enemy.x + enemy.width/2,
                                        enemy.y + enemy.height/2
                                    ));
                                }
                                
                                sounds.explosion.play();
                            }
                            
                            bullets.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // Update power-ups
                for (let i = powerups.length - 1; i >= 0; i--) {
                    powerups[i].update();
                    
                    // Check if player collected power-up
                    if (player.x < powerups[i].x + powerups[i].width &&
                        player.x + player.width > powerups[i].x &&
                        player.y < powerups[i].y + powerups[i].height &&
                        player.y + player.height > powerups[i].y) {
                        
                        player.powerups[powerups[i].type] = true;
                        powerupTimers[powerups[i].type] = powerupDuration;
                        powerups.splice(i, 1);
                        sounds.powerup.play();
                        updateHUD();
                        continue;
                    }
                    
                    if (powerups[i].isOffScreen()) {
                        powerups.splice(i, 1);
                    }
                }
                
                // Update power-up timers
                updatePowerupTimers();
                
                // Level progression
                levelTimer++;
                if (levelTimer >= levelDuration || enemiesDefeated >= enemiesToDefeat) {
                    // Check if boss battle
                    if (Math.random() < 0.3) { // 30% chance
                        startBossBattle();
                    } else {
                        showTriviaQuestion();
                    }
                }
                
                // Draw everything
                for (const bullet of bullets) {
                    bullet.draw();
                }
                
                for (const enemy of enemies) {
                    enemy.draw();
                }
                
                for (const powerup of powerups) {
                    powerup.draw();
                }
                
                drawPlayer();
                
                // Draw level progress bar
                const progressWidth = 200 * Math.min(1, levelTimer / levelDuration);
                ctx.fillStyle = 'red';
                ctx.fillRect(CANVAS_WIDTH/2 - 100, CANVAS_HEIGHT - 20, 200, 10);
                ctx.fillStyle = 'green';
                ctx.fillRect(CANVAS_WIDTH/2 - 100, CANVAS_HEIGHT - 20, progressWidth, 10);
            }
            
            // Continue game loop
            requestAnimationFrame(gameLoop);
        }
        
        // Start the game
        initGame();
    </script>
</body>
</html>
